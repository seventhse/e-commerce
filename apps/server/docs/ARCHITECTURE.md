# E-Commerce Server 系统架构文档

## 系统概述

本系统是一个基于NestJS框架开发的电子商务后台管理系统，采用模块化设计，实现了用户认证、权限管理、商品管理、订单管理等核心功能。系统使用PostgreSQL作为数据库，Prisma作为ORM工具，JWT实现认证机制。

## 技术栈

- **框架**: NestJS
- **数据库**: PostgreSQL
- **ORM**: Prisma
- **认证**: JWT (JSON Web Token)
- **API文档**: Swagger
- **日志**: 自定义LoggerService

## 系统架构

### 目录结构

```
src/
├── common/                 # 通用模块和工具
│   ├── decorator/          # 装饰器
│   ├── dto/                # 通用DTO
│   ├── exceptions/         # 异常处理
│   ├── guard/              # 守卫
│   ├── logger/             # 日志服务
│   ├── prisma/             # Prisma服务
│   └── utils/              # 工具函数
├── modules/                # 业务模块
│   └── manage/             # 管理模块
│       ├── address/        # 地址管理
│       ├── auth/           # 认证管理
│       ├── cart-item/      # 购物车管理
│       ├── commodity/      # 商品管理
│       ├── commodity-category/ # 商品分类管理
│       ├── consumer/       # 客户管理
│       ├── distribution/   # 分销管理
│       ├── order/          # 订单管理
│       ├── order-item/     # 订单项管理
│       ├── permission/     # 权限管理
│       ├── role/           # 角色管理
│       └── user/           # 用户管理
├── app.module.ts           # 应用主模块
└── main.ts                 # 应用入口
```

## 核心模块说明

### 1. 认证模块 (Auth)

负责用户登录、登出、令牌刷新和用户信息获取。

- **主要文件**:
  - `auth.controller.ts`: 处理认证相关的HTTP请求
  - `auth.service.ts`: 实现认证业务逻辑
  - `auth.module.ts`: 模块定义
  - `dto/signIn.dto.ts`: 登录数据传输对象

- **主要功能**:
  - 用户登录 (支持用户名、邮箱、手机号登录)
  - 用户登出
  - 获取用户信息
  - 刷新访问令牌

### 2. 用户模块 (User)

管理系统用户，包括创建、更新、删除用户，以及用户角色分配。

- **主要功能**:
  - 用户CRUD操作
  - 用户角色分配
  - 用户密码更新

### 3. 角色模块 (Role)

管理系统角色，包括角色的创建、更新、删除，以及角色权限分配。

- **主要功能**:
  - 角色CRUD操作
  - 角色权限分配

### 4. 权限模块 (Permission)

管理系统权限，包括权限的创建、更新、删除。

- **主要功能**:
  - 权限CRUD操作
  - 获取角色权限

### 5. 商品模块 (Commodity)

管理商品信息，包括商品的创建、更新、删除，以及商品分类。

- **主要功能**:
  - 商品CRUD操作
  - 商品图片管理

### 6. 商品分类模块 (CommodityCategory)

管理商品分类，包括分类的创建、更新、删除。

- **主要功能**:
  - 商品分类CRUD操作

### 7. 客户模块 (Consumer)

管理客户信息，包括客户的创建、更新、删除。

- **主要功能**:
  - 客户CRUD操作

### 8. 地址模块 (Address)

管理客户地址，包括地址的创建、更新、删除。

- **主要功能**:
  - 地址CRUD操作

### 9. 购物车模块 (CartItem)

管理客户购物车，包括购物车项的添加、更新、删除。

- **主要功能**:
  - 购物车项CRUD操作

### 10. 订单模块 (Order)

管理订单信息，包括订单的创建、更新、删除。

- **主要功能**:
  - 订单CRUD操作

### 11. 订单项模块 (OrderItem)

管理订单项，包括订单项的创建、更新、删除。

- **主要功能**:
  - 订单项CRUD操作

### 12. 分销模块 (Distribution)

管理销售人员与客户的关系，实现分销功能。

- **主要功能**:
  - 分销关系CRUD操作

## 数据库模型

系统使用Prisma ORM，主要数据模型包括：

1. **User**: 系统用户
2. **Role**: 角色
3. **Permission**: 权限
4. **UserRole**: 用户-角色关联
5. **RolePermission**: 角色-权限关联
6. **Consumer**: 客户
7. **Address**: 地址
8. **Commodity**: 商品
9. **CommodityCategory**: 商品分类
10. **CommodityImage**: 商品图片
11. **CartItem**: 购物车项
12. **Order**: 订单
13. **OrderItem**: 订单项
14. **Distribution**: 分销关系

## 认证与授权

系统使用JWT进行认证，通过自定义守卫实现授权。

- **认证流程**:
  1. 用户登录，提供凭证
  2. 服务器验证凭证，生成JWT令牌
  3. 客户端在后续请求中携带令牌
  4. 服务器验证令牌有效性

- **授权机制**:
  - 基于角色的访问控制 (RBAC)
  - 通过自定义装饰器和守卫实现

## API文档

系统使用Swagger生成API文档，在开发环境中可通过`/api/docs`路径访问。

## 业务流程

### 订单处理流程

1. 客户将商品添加到购物车
2. 客户创建订单
3. 系统创建订单项
4. 客户支付订单
5. 系统更新订单状态
6. 系统发货
7. 客户确认收货
8. 订单完成

### 分销流程

1. 销售人员关联客户
2. 客户下单
3. 系统记录销售业绩

## 扩展性考虑

系统设计考虑了以下扩展点：

1. **模块化设计**: 便于添加新功能模块
2. **中间件机制**: 支持添加全局或特定路由的中间件
3. **拦截器**: 可用于实现日志、缓存等横切关注点
4. **自定义装饰器**: 简化常用功能的实现
